name: Production Database Migration

# Trigger this action ONLY when code is pushed/merged to the 'main' branch
on:
  push:
    branches:
      - main
    paths:
      - 'prisma/migrations/**' # Only run if migration files actually changed
      - 'prisma/schema.prisma' # Or if the schema changed

jobs:
  deploy-migrations:
    name: Apply Migrations to Production
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the code
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2. Setup Bun environment
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 3. Install dependencies
      # --frozen-lockfile ensures it strictly follows your bun.lockb (like npm ci)
      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # 4. Apply the Migration
      # We use 'bunx' (Bun's executor) instead of npx
      - name: Run Prisma Migrate Deploy
        run: bunx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}